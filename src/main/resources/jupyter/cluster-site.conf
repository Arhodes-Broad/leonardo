<VirtualHost _default_:${SSL_HTTPD_PORT}>

    SSLEngine on
    SSLProxyEngine on
    SSLCertificateFile "/etc/ssl/certs/server.crt"
    SSLCertificateKeyFile "/etc/ssl/private/server.key"
    SSLCACertificateFile "/etc/ssl/certs/ca-bundle.crt"

    SSLVerifyClient require
    SSLVerifyDepth 10

    RewriteEngine on

    # RStudio
    RewriteCond %{HTTP:Upgrade} =websocket
    RewriteCond %{REQUEST_URI} /notebooks/[^/]*/[^/]*/rstudio/.* [NC]
    RewriteRule /notebooks/[^/]*/[^/]*/rstudio/(.*)     ws://127.0.0.1:8001/$1  [P,L]

    RewriteCond %{HTTP:Upgrade} !=websocket
    RewriteCond %{REQUEST_URI} /notebooks/[^/]*/[^/]*/rstudio/.* [NC]
    RewriteRule /notebooks/[^/]*/[^/]*/rstudio/(.*)     http://127.0.0.1:8001/$1 [P,L]

    ProxyPass /notebooks/[^/]*/[^/]*/rstudio/ http://127.0.0.1:8001/
    ProxyPassReverse /notebooks/[^/]*/[^/]*/rstudio/ http://127.0.0.1:8001/

    # Galaxy
    RewriteCond %{HTTP:Upgrade} =websocket
    RewriteCond %{REQUEST_URI} /notebooks/[^/]*/[^/]*/galaxy/.* [NC]
    RewriteRule /notebooks/[^/]*/[^/]*/galaxy/(.*)     ws://127.0.0.1:9080/$1  [P,L]

    RewriteCond %{HTTP:Upgrade} !=websocket
    RewriteCond %{REQUEST_URI} /notebooks/[^/]*/[^/]*/galaxy/.* [NC]
    RewriteRule /notebooks/[^/]*/[^/]*/galaxy/(.*)     http://127.0.0.1:9080/$1 [P,L]

    ProxyPass /notebooks/[^/]*/[^/]*/galaxy/ http://127.0.0.1:9080/
    ProxyPassReverse /notebooks/[^/]*/[^/]*/galaxy/ http://127.0.0.1:9080/

    # Jupyter
    RewriteCond %{HTTP:Upgrade} =websocket
    RewriteCond %{REQUEST_URI} !/notebooks/[^/]*/[^/]*/rstudio/.* [NC]
    RewriteCond %{REQUEST_URI} !/notebooks/[^/]*/[^/]*/galaxy/.* [NC]
    RewriteRule .*     ws://127.0.0.1:8000%{REQUEST_URI}  [P,L]

    RewriteCond %{HTTP:Upgrade} =websocket
    RewriteCond %{REQUEST_URI} !/notebooks/[^/]*/[^/]*/rstudio/.* [NC]
    RewriteCond %{REQUEST_URI} !/notebooks/[^/]*/[^/]*/galaxy/.* [NC]
    RewriteRule .*     http://127.0.0.1:8000%{REQUEST_URI}  [P,L]

    ProxyPass / http://127.0.0.1:8000/ retry=10
    ProxyPassReverse / http://127.0.0.1:8000/

</VirtualHost>